<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="qxx.information.mapper.SysUserMapper">

    <resultMap id="userVO" type="qxx.information.pojo.vo.SysUserVO" autoMapping="true">
        <id column="id" property="id" />
        <collection property="listHospital" ofType="qxx.information.entity.SysUserHospital">
            <id column="hospitalId" />
            <result column="hospital_name" property="hospitalName" />
        </collection>
        <collection property="listRole" ofType="qxx.information.entity.SysUserRole">
            <id column="roleId" />
            <result column="role_name" property="roleName" />
        </collection>
    </resultMap>

    <select id="selectPageNew" resultMap="userVO">
        with info as (select s.id,
        s.name,
        s.phone,
        s.user_id,
        s.password,
        s.status,
        s.delete_flag,
        s.create_by,
        s.create_on,
        h.id as hospitalId,
        i.hospital_name,
        r.id as roleId,
        m.name as roleName
        from sys_user s
        left join sys_user_hospital h on s.id = h.user_id left join hospital_info i on
        h.hospital_id = i.id
        <if test="dto.hospital != null and dto.hospital != ''">
            and i.hospital_name like concat('%', #{dto.hospital}, '%')
        </if>
        left join sys_user_role r on s.id = r.user_id left join sys_role m on r.role_id = m.id)
        select * from info
        where delete_flag = '0'
        <if test="dto.userId != null and dto.userId != ''">
            and s.user_id like concat('%', #{dto.userId}, '%')
        </if>
        <if test="dto.name != null and dto.name != ''">
            and s.name like concat('%', #{dto.name}, '%')
        </if>
    </select>
</mapper>
